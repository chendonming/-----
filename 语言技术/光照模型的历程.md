# 光照模型的历程

1.  **经验时代**：Phong 和 Blinn-Phong（直觉与几何）。
2.  **物理基石**：微平面理论（Microfacet Theory）。
3.  **现代标准**：PBR（基于物理的渲染）及其核心 Cook-Torrance 模型。

## 第一阶段：经验模型 (The Empirical Models)

早期的光照模型不是基于物理测量的，而是基于“看起来是对的”的观察。

### 1. Phong 光照模型 (Phong Reflection Model)
**核心思想**：物体表面的颜色 = 环境光(Ambient) + 漫反射(Diffuse) + 镜面反射(Specular)。

*   **漫反射 (Lambertian)**：基于**兰伯特余弦定律**。光线越垂直于表面，表面越亮。
    *   公式：$Diffuse = k_d \times (N \cdot L)$
    *   其中 $N$ 是法线，$L$ 是光照方向。点积结果小于0则截断为0。
*   **镜面反射 (Specular)**：Phong 认为，当视线方向($V$)与光线的反射方向($R$)重合时，高光最强。
    *   公式：$Specular = k_s \times (R \cdot V)^\alpha$
    *   其中 $\alpha$ 是光泽度（Shininess），值越大，光斑越小越锐利。

### 2. Blinn-Phong 模型
**工程师视角的优化**：
Phong 模型有一个计算痛点：计算反射向量 $R$ 需要用到 `reflect()` 函数，在早期的硬件上开销略大。Jim Blinn 提出了一种近似方法。

*   **半程向量 (Half Vector, $H$)**：光照方向 $L$ 和视线方向 $V$ 的中间向量。
    $$H = \frac{L + V}{||L + V||}$$
*   **原理**：当视线 $V$ 能够看到最强的高光时，法线 $N$ 应该刚好处于 $L$ 和 $V$ 的中间。所以我们只要比较 $N$ 和 $H$ 是否重合。
*   **公式**：$Specular = k_s \times (N \cdot H)^\alpha$

**Phong vs Blinn-Phong 的区别**：
*   **视觉**：Blinn-Phong 的高光过渡通常比 Phong 更柔和、更真实。
*   **性能**：在现代 GPU 上差异不大，但 Blinn-Phong 是后续 PBR 理论的几何雏形（微平面法线的概念），所以它更重要。
*   

## 第二阶段：微平面理论 (Microfacet Theory)

这是从经验走向物理的关键一步。

**核心理论**：
在微观尺度下，没有任何表面是绝对平滑的。我们可以假设物体表面是由无数个微小的、像镜子一样的**微平面 (Microfacets)** 组成的。

1.  **表面粗糙度 (Roughness)**：
    *   如果表面很光滑（Roughness 低），大部分微平面的法线都指向与宏观法线 $N$ 相同的方向。反射光线整齐划一，形成锐利的镜面反射。
    *   如果表面很粗糙（Roughness 高），微平面的朝向乱七八糟。反射光线向四面八方散射，形成模糊的高光。

2.  **微平面的光学行为**：
    每个微平面都被视为理想的镜面反射体。只有当一个微平面的法线 $m$ 刚好指在光线 $L$ 和视线 $V$ 的中间（即 $m = H$）时，光线才能反射进入我们的眼睛。

**结论**：光照计算变成了统计学问题——**我们要统计有多少比例的微平面，其朝向刚好能把光反射到摄影机里。**

## 第三阶段：PBR 与 Cook-Torrance BRDF

PBR（Physically Based Rendering）不是一种单一的技术，而是一套基于物理原理的渲染管线。其核心是 **Cook-Torrance BRDF**（双向反射分布函数）。

**工程核心公式 (渲染方程的简化版)**：
$$L_o = \int (k_d \frac{c}{\pi} + k_s f_{cook-torrance}) \cdot L_i \cdot (N \cdot L) d\omega$$

在 Shader 实现中，针对单个点光源，我们关注括号里的部分。
PBR 必须满足**能量守恒**：反射出去的光不能多于射入的光。
$$k_d + k_s \approx 1$$
*(注意：金属几乎没有漫反射，大部分光都被吸收或镜面反射了，这是工程实现的难点之一)*

### Cook-Torrance 镜面反射项 (The Big Boss)
这是你需要写在 Shader 里的核心算法：

$$f_{specular} = \frac{D \cdot F \cdot G}{4(\omega_o \cdot n)(\omega_i \cdot n)}$$

这里有三个极其重要的项：**D, F, G**。

### 1. D - 法线分布函数 (Normal Distribution Function)
**作用**：根据粗糙度，估算有多少微平面的法线与半程向量 $H$ 一致。
**常用算法**：**Trowbridge-Reitz GGX**。这是目前业界的标准。

*   **直观理解**：粗糙度越低，D函数在 $N=H$ 处的峰值越高越窄（高光亮且小）；粗糙度越高，峰值越低越宽（高光暗且大）。

### 2. G - 几何函数 (Geometry Function)
**作用**：描述微平面的自遮挡（Self-shadowing）和自掩蔽（Self-masking）。
**常用算法**：**Smith's Schlick-GGX**。

*   **直观理解**：
    *   **遮挡 (Shadowing)**：光照进来了，但被凸起的微平面挡住，照不到凹陷处。
    *   **掩蔽 (Masking)**：光反射出去了，但被凸起的微平面挡住，出不去。
*   表面越粗糙，G 项的值越小（光被损耗得越多）。

### 3. F - 菲涅尔方程 (Fresnel Equation)
**作用**：描述光线以不同角度入射时，被反射的比例。
**常用算法**：**Fresnel-Schlick 近似**。

*   **物理现象**：万物皆有菲涅尔效应。
    *   当你垂直观察水面时，你能看透水底（反射弱）。
    *   当你以近乎平行的角度观察水面时，水面像镜子一样（反射强）。
*   **工程参数 $F_0$**：这是 PBR 工作流中的关键。$F_0$ 代表**0度角入射（垂直表面）时的反射率**。
    *   **非金属 (Dielectrics)**：$F_0$ 通常很低且为灰度值（如 0.04）。
    *   **金属 (Conductors)**：$F_0$ 很高且带有颜色（如黄金的 $F_0$ 是黄色的）。
